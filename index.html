<div id="coinnectar-widget" style="max-width:420px;margin:auto;text-align:center;font-family:'Segoe UI',sans-serif;">
  <h2 style="color:#007bff;">CoinNectarBot - Earn Crypto</h2>
  <div id="balance" style="background:#d4edda;color:#155724;padding:10px;border-radius:8px;font-weight:bold;margin:10px 0;">
    Balance: $<span id="userBalance">0.00</span>
  </div>
  <p><strong>Ads Watched:</strong> <span id="adsWatched">0</span> / 20</p>
  <div style="height:10px;background:#e0e0e0;border-radius:5px;">
    <div id="progressBar" style="width:0%;height:100%;background:#007bff;border-radius:5px;"></div>
  </div>
  <p id="timer" style="margin-top:10px;color:#777;">Next reset in: 23h 59m</p>
  <p id="visitTime" style="margin-top:5px;color:#555;">Time on page: 0m 0s</p>
  <button id="watchAdBtn" style="background:#28a745;color:#fff;border:none;padding:12px 20px;border-radius:30px;cursor:pointer;margin-top:15px;">ðŸŽ¬ Watch Ad ($0.01)</button>
  <p style="font-size:0.8em;color:#888;margin-top:15px;">Powered by CoinNectarBot</p>
</div>

<!-- MoneTag SDK -->
<script src="https://libtl.com/sdk.js" data-zone="10030164" data-sdk="show_10030164"></script>

<!-- Adsterra backup banner -->
<script type="text/javascript" src="//pl27620444.effectivegatecpm.com/fb/7c/fe/fb7cfe1564e94bf1ad4d65f6f3f36804.js"></script>

<script>
const userBalanceEl = document.getElementById('userBalance');
const adsWatchedEl = document.getElementById('adsWatched');
const progressBar = document.getElementById('progressBar');
const timerEl = document.getElementById('timer');
const watchAdBtn = document.getElementById('watchAdBtn');
const visitTimeEl = document.getElementById('visitTime');

// Load saved balance and ads count
let userBalance = parseFloat(localStorage.getItem('cn_balance')) || 0.00;
let adsWatched = parseInt(localStorage.getItem('cn_adsWatched')) || 0;
let lastReset = parseInt(localStorage.getItem('cn_lastReset')) || Date.now();

const dailyLimit = 20;
const adReward = 0.01;

// Track visit time (not saved)
let visitStart = Date.now();

// Save balance and ads count
function saveData(){
  localStorage.setItem('cn_balance', userBalance.toFixed(2));
  localStorage.setItem('cn_adsWatched', adsWatched);
  localStorage.setItem('cn_lastReset', lastReset);
}

// Update UI
function updateUI(){
  userBalanceEl.textContent = userBalance.toFixed(2);
  adsWatchedEl.textContent = adsWatched;
  progressBar.style.width = `${(adsWatched/dailyLimit)*100}%`;

  if(adsWatched >= dailyLimit){
    watchAdBtn.disabled = true;
    watchAdBtn.textContent = "âœ… Daily Limit Reached";
    watchAdBtn.style.background = "#6c757d";
  } else {
    watchAdBtn.disabled = false;
    watchAdBtn.textContent = `ðŸŽ¬ Watch Ad ($${adReward.toFixed(2)})`;
    watchAdBtn.style.background = "#28a745";
  }

  saveData();
}

// Reset daily limit if 24h passed
function resetDaily(){
  const now = Date.now();
  if(now - lastReset >= 24*60*60*1000){
    adsWatched = 0;
    lastReset = now;
    saveData();
  }
}

// Countdown for next reset
function countdown(){
  const now = Date.now();
  const nextReset = lastReset + 24*60*60*1000;
  const left = nextReset - now;

  if(left <= 0){
    resetDaily();
    updateUI();
    return;
  }

  const h = Math.floor(left / (1000*60*60));
  const m = Math.floor((left % (1000*60*60)) / (1000*60));
  const s = Math.floor((left % (1000*60)) / 1000);
  timerEl.textContent = `Next reset in: ${h}h ${m}m ${s}s`;
}

// Track visit time (resets on refresh)
function trackVisitTime(){
  const now = Date.now();
  const diff = now - visitStart;
  const m = Math.floor(diff / (1000*60));
  const s = Math.floor((diff % (1000*60)) / 1000);
  visitTimeEl.textContent = `Time on page: ${m}m ${s}s`;
}

// Show ad: MoneTag or Adsterra
async function startAd(){
  if(adsWatched >= dailyLimit) return;

  watchAdBtn.disabled = true;
  watchAdBtn.textContent = "Loading Ad...";

  // **Add reward immediately** when ad starts
  adsWatched++;
  userBalance += adReward;
  updateUI();

  try {
    let adCompleted = false;

    // MoneTag first
    if(typeof show_10030164 === 'function'){
      adCompleted = await new Promise(resolve => {
        show_10030164({
          onComplete: () => resolve(true),
          onCloseEarly: () => resolve(false)
        });
      });
    }

    // If MoneTag fails or closed early, fallback Adsterra
    if(!adCompleted){
      adCompleted = await new Promise(resolve => {
        const adWin = confirm("ðŸ’¡ Watch Adsterra ad completely to continue.");
        resolve(adWin);
      });
    }

  } catch(e){
    console.error(e);
  }

  watchAdBtn.disabled = false;
  watchAdBtn.textContent = `ðŸŽ¬ Watch Ad ($${adReward.toFixed(2)})`;
}

// Initialize
watchAdBtn.addEventListener('click', startAd);
resetDaily();
updateUI();
setInterval(countdown, 1000);
setInterval(trackVisitTime, 1000);
</script>
